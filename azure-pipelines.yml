# ASP.NET
# Build and test ASP.NET projects.
# Add steps that publish symbols, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/apps/aspnet/build-aspnet-4

trigger:
- main

pool: Default

container:
  image: 'itsyou0o/playwright-with-docker:latest'
  mapDockerSocket: true

variables:
  solution: 'Budget.sln'
  buildPlatform: 'Any CPU'
  buildConfiguration: 'Release'
  NUGET_PACKAGES: $(Pipeline.Workspace)/.nuget/packages
  LANG: en_NL.UTF-8
  dockerAppImage: $(RegistryHost)/budget
  dockerApiImage: $(RegistryHost)/budget-api

steps:

- task: UseDotNet@2
  inputs:
    packageType: sdk
    version: '8.0.x'
  displayName: 'Use .NET SDK'

  
- task: PowerShell@2
  displayName: 'Set api appsettings.json for test'
  env:
    API_SWAGGER_CLIENTID: $(api_swagger_clientid)
    API_SWAGGER_AUTHORIZEURL: $(api_swagger_authorizeurl)
    API_SWAGGER_SCOPES: $(api_swagger_scopes)
    API_AZUREAD_TENTANTID: $(app_azuread_tentantid)
    API_AZUREAD_SCOPES: $(api_azuread_scopes)
    API_AZUREAD_INSTANCE: $(api_azuread_instance)
    API_AZUREAD_DOMAIN: $(api_azuread_domain)
    API_AZUREAD_CLIENTID: $(api_azuread_clientid)
    API_AZUREAD_CALLBACKPATH: $(api_azuread_callbackpath)
  inputs:
    targetType: 'inline'
    script: |
      # Define the path to your appsettings.json file
      $filePath = "./Budget.Api/appsettings.Development.json"
      
      # Create a hashtable with the desired key-value pairs
      $appSettings = @"
      {
          "Swagger": {
              "ClientId": "$env:API_SWAGGER_CLIENTID",
              "AuthorizeUrl": "$env:API_SWAGGER_AUTHORIZEURL",
              "Scopes": "$env:API_SWAGGER_SCOPES"
          },
          "AzureAd": {
              "TenantId": "$env:API_AZUREAD_TENTANTID",
              "Scopes": "$env:API_AZUREAD_SCOPES",
              "Instance": "$env:API_AZUREAD_INSTANCE",
              "Domain": "$env:API_AZUREAD_DOMAIN",
              "ClientId": "$env:API_AZUREAD_CLIENTID",
              "CallbackPath": "$env:API_AZUREAD_CALLBACKPATH"
          }
      }
      "@
      
      # Write the JSON content to the appsettings.json file
      $appSettings | Set-Content -Path $filePath

- task: PowerShell@2
  displayName: Add app appsettings.json values for test
  env:
    APP_AZUREAD_INSTANCE: $(app_azuread_instance)
    APP_AZUREAD_TENTANTID: $(app_azuread_tentantid)
    APP_AZUREAD_CLIENTID: $(app_azuread_clientid)
    APP_AZUREAD_CLIENTSECRET: $(app_azuread_clientsecret)
    APP_API_SCOPES: $(api_swagger_scopes)
  inputs:
    targetType: 'inline'
    script: |
      # Define the path to your appsettings.json file
      $filePath = "./Budget.App/appsettings.Development.json"
      
      # Create a hashtable with the desired key-value pairs
      $appSettings = @"
      {
        "DetailedErrors": true,
        "AzureAd": 
        {
          "Instance": "$env:APP_AZUREAD_INSTANCE",
          "TenantId": "$env:APP_AZUREAD_TENTANTID",
          "ClientId": "$env:APP_AZUREAD_CLIENTID",
          "ClientCredentials": [
            {
              "SourceType": "ClientSecret",
              "ClientSecret": "$env:APP_AZUREAD_CLIENTSECRET"
            }
          ]
        },
        "Api": 
        {
          "BaseUrl": "https://localhost:5078",
          "Scopes": ["$env:APP_API_SCOPES"]
        }
      }
      "@
      Write-Host ${env:app_api_scopes}
      Write-Host ${env:app_azuread_tentantid}
      # Write the JSON content to the appsettings.json file
      $appSettings | Set-Content -Path $filePath

- script: 'dotnet restore $(solution) --locked-mode'
  displayName: 'Restore'
  
- script: 'dotnet build $(solution) --no-restore'
  displayName: 'Build'

- script: 'mkdir ./Budget.BlazorTests/bin/Debug/net8.0/playwright-traces'
  displayName: 'Create directory for test traces'

- task: CmdLine@2
  displayName: 'Test'
  inputs:
    script: 'dotnet test $(solution) --no-restore --no-build'
  env:
    ASPNETCORE_ENVIRONMENT: 'Development'
    Url: $(TestUrl)
    User__Username: $(TestUser)
    User__Password: $(TestPassword)
    User__OtpSecret: $(TestOtpSecret)

- publish: ./Budget.BlazorTests/bin/Debug/net8.0/playwright-traces
  artifact: TestResult
  condition: failed()

- publish: ./Budget.App/appsettings.Production.json
  artifact: Testresult

- script: 'echo "$(RegistryPassword)" | docker login -u $(RegistryUsername) --password-stdin $(RegistryHost)'
  displayName: Docker Login

- script: 'docker build -t $(dockerApiImage) -t $(dockerApiImage):$(Build.SourceVersion) -t $(dockerApiImage):latest . --file Budget.Api/Dockerfile '
  displayName: Docker Build Api

- script: 'docker push -a $(dockerApiImage)'
  displayName: Docker Push Api
  
- script: 'docker build -t $(dockerAppImage) -t $(dockerAppImage):$(Build.SourceVersion) -t $(dockerAppImage):latest . --file Budget.App/Dockerfile '
  displayName: Docker Build App

- script: 'docker push -a $(dockerAppImage)'
  displayName: Docker Push App

- task: SSH@0
  displayName: 'Deploy'
  inputs:
    sshEndpoint: 'Home SSH'
    runOptions: 'commands'
    commands: '/etc/webhook/commands/budget-deploy.sh'
    failOnStdErr: true
    readyTimeout: '20000'





