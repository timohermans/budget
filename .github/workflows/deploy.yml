name: Deployment on home server

# When this action will be executed
on:
  workflow_run:
    branches: [ blazor ]
    workflows: [ .NET ]
    types:
      - completed

  # Allow manual trigger 
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Build the Docker image
        run: docker build . --file Budget.App/Dockerfile --tag ${{secrets.HOME_BUDGET_REGISTRY_HOST}}/budget
      - name: Tag Image Commit sha
        run: docker tag ${{secrets.HOME_BUDGET_REGISTRY_HOST}}/budget ${{secrets.HOME_BUDGET_REGISTRY_HOST}}/budget:${{github.sha}}
      - name: Tag Image Latest
        run: docker tag ${{secrets.HOME_BUDGET_REGISTRY_HOST}}/budget ${{secrets.HOME_BUDGET_REGISTRY_HOST}}/budget:latest
      - name: Login To Registry
        run: echo "${{secrets.HOME_BUDGET_REGISTRY_PASSWORD}}" | docker login -u ${{secrets.HOME_BUDGET_REGISTRY_USERNAME}} --password-stdin ${{secrets.HOME_BUDGET_REGISTRY_HOST}}
      - name: Push To Registry
        run: docker push -a ${{secrets.HOME_BUDGET_REGISTRY_HOST}}/budget
